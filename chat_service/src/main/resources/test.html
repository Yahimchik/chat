<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Simple Chat Client</title>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            background-color: #f4f4f8;
        }

        .container {
            max-width: 800px;
            width: 100%;
            background: white;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }

        #controls, #chat-area {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π */
        #messages {
            height: 400px;
            border: 1px solid #ccc;
            padding: 10px;
            overflow-y: scroll;
            margin-bottom: 10px;
            background: #fafafa;
            display: flex;
            flex-direction: column;
        }

        /* –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏—è */
        .message {
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 12px;
            max-width: 70%;
            word-wrap: break-word;
        }

        /* –°–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è - –≤—ã—Ä–æ–≤–Ω–µ–Ω—ã –ø–æ –ø—Ä–∞–≤–æ–º—É –∫—Ä–∞—é */
        .message.client {
            background-color: #007bff;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        /* –ß—É–∂–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è - –≤—ã—Ä–æ–≤–Ω–µ–Ω—ã –ø–æ –ª–µ–≤–æ–º—É –∫—Ä–∞—é */
        .message.other {
            background-color: #e9ecef;
            color: #333;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }

        /* –í—Ä–µ–º—è —Å–æ–æ–±—â–µ–Ω–∏—è */
        .message-time {
            font-size: 0.8em;
            opacity: 0.8;
        }

        /* –ò–º—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è */
        .message-sender {
            font-weight: bold;
            font-size: 0.9em;
        }

        /* –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è */
        .message-content {
            font-size: 1em;
        }

        .typing-indicator {
            color: #666;
            font-style: italic;
            padding: 5px 10px;
            font-size: 0.9em;
        }

        .input-group {
            display: flex;
            margin-bottom: 10px;
        }

        input {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        button {
            padding: 8px 12px;
            margin-left: 10px;
            background-color: #2196f3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        h3 {
            margin-top: 0;
            color: #333;
        }

        #status, #room-info {
            font-weight: bold;
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 4px;
        }

        #status.connected {
            background-color: #e8f5e8;
            color: #2e7d32;
        }

        #status.disconnected {
            background-color: #ffebee;
            color: #c62828;
        }

        #notifications {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #fffde7;
        }

        .notification-item {
            padding: 5px;
            border-bottom: 1px solid #eee;
            font-size: 0.9em;
        }

        .notification-item:last-child {
            border-bottom: none;
        }

        .user-typing {
            display: flex;
            align-items: center;
            padding: 5px 10px;
            color: #666;
            font-size: 0.9em;
        }

        .typing-dots {
            display: inline-flex;
            margin-left: 5px;
        }

        .typing-dot {
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background-color: #666;
            margin: 0 1px;
            animation: typingAnimation 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing-dot:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes typingAnimation {
            0%, 80%, 100% {
                transform: scale(0);
            }
            40% {
                transform: scale(1);
            }
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π */
        .test-section {
            margin: 15px 0;
            padding: 10px;
            background: #f0f8ff;
            border-radius: 5px;
        }
    </style>
</head>
<body>

<div class="container">
    <h2>WebSocket –ß–∞—Ç-–ö–ª–∏–µ–Ω—Ç —Å –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏</h2>

    <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
    <div id="controls">
        <h3>1. –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è</h3>
        <p>–í—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à JWT —Ç–æ–∫–µ–Ω (–±–µ–∑ "Bearer ") –∏ –Ω–∞–∂–º–∏—Ç–µ "–í–æ–π—Ç–∏".</p>
        <div class="input-group">
            <input type="text" id="jwt-token" placeholder="–í–∞—à JWT —Ç–æ–∫–µ–Ω..." style="flex: 3;">
            <button onclick="login()" style="flex: 1;">–í–æ–π—Ç–∏</button>
        </div>
        <div id="user-info"></div>
    </div>

    <!-- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
    <div class="test-section">
        <h4>üîß –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</h4>
        <button onclick="testNotification()" style="background: #ff9800;">–¢–µ—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</button>
        <button onclick="checkNotificationConnection()" style="background: #9c27b0;">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</button>
    </div>

    <!-- –û–±–ª–∞—Å—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
    <div id="notifications-area" style="display: none;">
        <h3>üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h3>
        <div id="notifications"></div>
    </div>

    <!-- –û–±–ª–∞—Å—Ç—å —á–∞—Ç–∞ -->
    <div id="chat-area" style="display: none;">
        <h3>2. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–∞—Ç–æ–º</h3>
        <div class="input-group">
            <input type="text" id="recipient-id" placeholder="ID –ø–æ–ª—É—á–∞—Ç–µ–ª—è (UUID)...">
            <button onclick="startPrivateChat()">–ù–∞—á–∞—Ç—å –ø—Ä–∏–≤–∞—Ç–Ω—ã–π —á–∞—Ç</button>
        </div>
        <div id="room-info"></div>
        <div id="status" class="disconnected">–°—Ç–∞—Ç—É—Å: –û—Ç–∫–ª—é—á–µ–Ω–æ</div>

        <h3>3. –ß–∞—Ç</h3>
        <div id="typing-indicator"></div>
        <div id="messages"></div>

        <div class="input-group">
            <input type="text" id="message-content" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." disabled
                   onkeyup="handleTyping(event)" onfocus="startTyping()" onblur="stopTyping()">
            <button id="send-button" onclick="sendMessage()" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
    </div>
</div>

<script>
    // --- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ---
    let stompClient = null;
    let jwtToken = null;
    let currentRoomId = null;
    let currentUserId = null;
    let currentUserName = null;
    let typingTimeout = null;
    let isTyping = false;
    let typingUsers = new Set(); // –ú–Ω–æ–∂–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –ø–µ—á–∞—Ç–∞—é—Ç

    const API_BASE_URL = 'http://localhost:8080';
    // const API_BASE_URL = 'https://dev.internal.breed.show';

    // --- –§—É–Ω–∫—Ü–∏–∏ ---

    function login() {
        const tokenInput = document.getElementById('jwt-token');
        if (!tokenInput.value) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—Å—Ç–∞–≤—å—Ç–µ JWT —Ç–æ–∫–µ–Ω.');
            return;
        }
        jwtToken = tokenInput.value;

        try {
            // –î–µ–∫–æ–¥–∏—Ä—É–µ–º JWT —Ç–æ–∫–µ–Ω
            const payload = JSON.parse(atob(jwtToken.split('.')[1]));

            // ‚úÖ –ò—â–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ä–∞–∑–Ω—ã—Ö –≤–æ–∑–º–æ–∂–Ω—ã—Ö –ø–æ–ª—è—Ö
            currentUserId = payload.sub || payload.userId || payload.id || payload.username;
            currentUserName = payload.name || payload.username || payload.preferred_username || 'User';

            if (currentUserId) {
                document.getElementById('user-info').innerText = `–í—ã –≤–æ—à–ª–∏ –∫–∞–∫: ${currentUserName} (ID: ${currentUserId})`;
                document.getElementById('chat-area').style.display = 'block';
                document.getElementById('notifications-area').style.display = 'block';

                // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–π –æ—á–µ—Ä–µ–¥–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
                connectToNotifications();
            } else {
                document.getElementById('user-info').innerText = `–í—ã –≤–æ—à–ª–∏ (ID –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Ç–æ–∫–µ–Ω–µ)`;
                document.getElementById('chat-area').style.display = 'block';
                document.getElementById('notifications-area').style.display = 'block';
                console.warn('ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ JWT. –î–æ—Å—Ç—É–ø–Ω—ã–µ –ø–æ–ª—è:', Object.keys(payload));
            }
        } catch (e) {
            alert('–ù–µ —É–¥–∞–ª–æ—Å—å –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å JWT. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–æ–∫–µ–Ω.');
            console.error("–û—à–∏–±–∫–∞ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è JWT:", e);
        }
    }

    function connectToNotifications() {
        if (!currentUserId) return;

        // –°–æ–∑–¥–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        const notificationSocket = new WebSocket(`${API_BASE_URL}/ws?token=${jwtToken}`);
        const notificationClient = Stomp.over(notificationSocket);

        notificationClient.debug = function (str) {
            console.log('STOMP Notifications Debug:', str);
        };

        const headers = {
            'Authorization': 'Bearer ' + jwtToken
        };

        notificationClient.connect(headers,
            (frame) => {
                console.log('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');

                // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—É—é –æ—á–µ—Ä–µ–¥—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
                notificationClient.subscribe(`/user/${currentUserId}/queue/notifications`, (message) => {
                    console.log('üîî –ü–æ–ª—É—á–µ–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ:', message.body);
                    const notification = JSON.parse(message.body);
                    displayNotification(notification);
                });

            },
            (error) => {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º:', error);
            }
        );
    }

    async function startPrivateChat() {
        const recipientId = document.getElementById('recipient-id').value;
        if (!recipientId) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—É—á–∞—Ç–µ–ª—è.');
            return;
        }

        console.log(`–ü–æ–ø—ã—Ç–∫–∞ —Å–æ–∑–¥–∞—Ç—å —á–∞—Ç —Å ${recipientId}`);
        updateRoomInfo('–°–æ–∑–¥–∞–Ω–∏–µ/–ø–æ–∏—Å–∫ –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ —á–∞—Ç–∞...');

        try {
            const response = await fetch(`${API_BASE_URL}/api/v1/chats/private/${recipientId}`, {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + jwtToken,
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status}`);
            }

            const data = await response.json();
            currentRoomId = data.roomId;
            console.log('–ü–æ–ª—É—á–µ–Ω roomId:', currentRoomId);

            updateRoomInfo(`ID –∫–æ–º–Ω–∞—Ç—ã: ${currentRoomId}`);
            connectToWebSocket();

        } catch (error) {
            console.error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å/–Ω–∞–π—Ç–∏ —á–∞—Ç:', error);
            updateRoomInfo('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —á–∞—Ç–∞!');
        }
    }

    function connectToWebSocket() {
        if (!currentRoomId) {
            alert('–°–Ω–∞—á–∞–ª–∞ –Ω—É–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å ID –∫–æ–º–Ω–∞—Ç—ã!');
            return;
        }
        if (stompClient && stompClient.connected) {
            stompClient.disconnect();
        }

        console.log('üîÑ –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ WebSocket...');
        console.log('Room ID:', currentRoomId);

        const socket = new WebSocket(`${API_BASE_URL}/ws?token=${jwtToken}`);
        stompClient = Stomp.over(socket);

        stompClient.debug = function (str) {
            console.log('STOMP Debug:', str);
        };

        const headers = {
            'Authorization': 'Bearer ' + jwtToken
        };

        stompClient.connect(headers,
            (frame) => {
                console.log('‚úÖ –£—Å–ø–µ—à–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ:', frame);
                updateStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ', true);

                // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –∫–æ–º–Ω–∞—Ç–µ
                stompClient.subscribe(`/topic/room/${currentRoomId}`, (message) => {
                    console.log('üì® –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ:', message.body);
                    const msg = JSON.parse(message.body);
                    displayMessage(msg, msg.senderId === currentUserId);
                });

                // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∏–Ω–¥–∏–∫–∞—Ü–∏—é –Ω–∞–±–æ—Ä–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
                stompClient.subscribe(`/topic/room/${currentRoomId}/typing`, (typingEvent) => {
                    console.log('‚å®Ô∏è –ü–æ–ª—É—á–µ–Ω typing event:', typingEvent.body);
                    handleTypingEvent(JSON.parse(typingEvent.body));
                });

                loadMessageHistory();
            },
            (error) => {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:', error);
                updateStatus('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è!', false);
            }
        );
    }

    function displayMessage(msg, isClient) {
        const messagesDiv = document.getElementById('messages');
        const messageEl = document.createElement('div');

        if (isClient) {
            messageEl.className = 'message client';
        } else {
            messageEl.className = 'message other';
        }

        const sender = msg.senderName || msg.senderId.substring(0, 8);

        // ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä—É—Å—Å–∫—É—é –ª–æ–∫–∞–ª—å –¥–ª—è 24-—á–∞—Å–æ–≤–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞
        const time = new Date(msg.createdAt).toLocaleTimeString('ru-RU', {
            hour: '2-digit',
            minute: '2-digit',
            hour12: false // –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ 24-—á–∞—Å–æ–≤–æ–π —Ñ–æ—Ä–º–∞—Ç
        });

        messageEl.innerHTML = `
        <div class="message-time">[${time}]</div>
        <div class="message-sender">${sender}:</div>
        <div class="message-content">${msg.content}</div>
    `;

        messagesDiv.appendChild(messageEl);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function handleTyping(event) {
        if (event.key === 'Enter') {
            sendMessage();
            return;
        }

        if (!isTyping) {
            startTyping();
        }

        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–∞–π–º–µ—Ä –ø—Ä–∏ –∫–∞–∂–¥–æ–º –Ω–∞–∂–∞—Ç–∏–∏
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(stopTyping, 2000);
    }

    function startTyping() {
        if (!stompClient || !stompClient.connected || !currentRoomId || isTyping) return;

        isTyping = true;

        const headers = {
            'Authorization': 'Bearer ' + jwtToken
        };

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏–µ –Ω–∞–±–æ—Ä–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        stompClient.send(
            `/app/chat/${currentRoomId}/typing`,
            headers,
            JSON.stringify({}) // –ü—É—Å—Ç–æ–µ —Ç–µ–ª–æ, —Ç–∞–∫ –∫–∞–∫ –¥–∞–Ω–Ω—ã–µ –±–µ—Ä—É—Ç—Å—è –∏–∑ Principal
        );

        console.log('‚å®Ô∏è –û—Ç–ø—Ä–∞–≤–ª–µ–Ω typing event');
    }

    function stopTyping() {
        if (!isTyping) return;

        isTyping = false;
        clearTimeout(typingTimeout);

        // –£–±–∏—Ä–∞–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Å–ø–∏—Å–∫–∞ –ø–µ—á–∞—Ç–∞—é—â–∏—Ö
        typingUsers.delete(currentUserId);
        updateTypingIndicator();

        console.log('‚å®Ô∏è –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω typing');
    }

    function handleTypingEvent(typingData) {
        const userId = typingData.userId;
        const userName = typingData.userName;

        if (userId === currentUserId) return; // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–±—è

        // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –º–Ω–æ–∂–µ—Å—Ç–≤–æ –ø–µ—á–∞—Ç–∞—é—â–∏—Ö
        typingUsers.add(userName);

        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
        updateTypingIndicator();

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–±–∏—Ä–∞–µ–º —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(() => {
            typingUsers.delete(userName);
            updateTypingIndicator();
        }, 3000);
    }

    function updateTypingIndicator() {
        const indicator = document.getElementById('typing-indicator');

        if (typingUsers.size > 0) {
            const users = Array.from(typingUsers).join(', ');
            indicator.innerHTML = `
                <div class="user-typing">
                    ${users} –ø–µ—á–∞—Ç–∞–µ—Ç
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            `;
        } else {
            indicator.innerHTML = '';
        }
    }

    async function loadMessageHistory() {
        clearMessages();
        console.log(`–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –¥–ª—è –∫–æ–º–Ω–∞—Ç—ã ${currentRoomId}`);
        try {
            const response = await fetch(`${API_BASE_URL}/api/v1/chats/${currentRoomId}/messages`, {
                headers: {'Authorization': 'Bearer ' + jwtToken}
            });
            if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏');

            const page = await response.json();
            // –°–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–∏—Ö–æ–¥—è—Ç –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ (–Ω–æ–≤—ã–µ –≤–≤–µ—Ä—Ö—É), –ø–µ—Ä–µ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            page.content.reverse().forEach(msg => {
                displayMessage(msg, msg.senderId === currentUserId);
            });
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:", error);
        }
    }

    function sendMessage() {
        const contentInput = document.getElementById('message-content');
        const content = contentInput.value.trim();
        if (!content) return;

        const messageRequest = {
            content: content
        };

        console.log('üîÑ –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è');

        const headers = {
            'Authorization': 'Bearer ' + jwtToken
        };

        stompClient.send(
            `/app/chat/${currentRoomId}/sendMessage`,
            headers,
            JSON.stringify(messageRequest)
        );

        contentInput.value = '';
        stopTyping(); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ü–∏—é –Ω–∞–±–æ—Ä–∞ –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏
    }

    function displayNotification(notification) {
        const notificationsDiv = document.getElementById('notifications');
        const notificationEl = document.createElement('div');
        notificationEl.className = 'notification-item';

        const time = new Date(notification.timestamp).toLocaleTimeString();

        notificationEl.innerHTML = `
            <div><strong>${notification.title}</strong> <small>[${time}]</small></div>
            <div>${notification.message}</div>
            <small>–¢–∏–ø: ${notification.type}</small>
        `;

        notificationsDiv.appendChild(notificationEl);
        notificationsDiv.scrollTop = notificationsDiv.scrollHeight;

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (–µ—Å–ª–∏ –±—Ä–∞—É–∑–µ—Ä –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç)
        if ('Notification' in window && Notification.permission === 'granted') {
            new Notification(notification.title, {
                body: notification.message,
                icon: '/favicon.ico'
            });
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥
        setTimeout(() => {
            if (notificationEl.parentNode) {
                notificationEl.remove();
            }
        }, 10000);
    }

    // --- –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è ---

    function testNotification() {
        if (!currentUserId) {
            alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É!');
            return;
        }

        const testNotification = {
            type: "TEST_NOTIFICATION",
            title: "‚úÖ –¢–µ—Å—Ç –ø—Ä–æ–π–¥–µ–Ω!",
            message: "–°–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!",
            relatedEntityId: "test-" + Date.now(),
            relatedEntityType: "TEST",
            timestamp: new Date().toISOString()
        };

        displayNotification(testNotification);
        showBrowserNotification(testNotification);
    }

    function showBrowserNotification(notification) {
        if (!('Notification' in window)) {
            console.log('–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è');
            return;
        }

        if (Notification.permission === 'granted') {
            new Notification(notification.title, {
                body: notification.message,
                icon: '/favicon.ico'
            });
        } else if (Notification.permission === 'default') {
            Notification.requestPermission().then(permission => {
                if (permission === 'granted') {
                    new Notification(notification.title, {
                        body: notification.message,
                        icon: '/favicon.ico'
                    });
                }
            });
        }
    }

    function checkNotificationConnection() {
        console.log('=== –ü–†–û–í–ï–†–ö–ê –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø ===');
        console.log('ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', currentUserId);
        console.log('–¢–æ–∫–µ–Ω:', jwtToken ? '‚úÖ –ü—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç' : '‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç');
        console.log('–û—á–µ—Ä–µ–¥—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:', currentUserId ? '/user/' + currentUserId + '/queue/notifications' : '–ù–µ–¥–æ—Å—Ç—É–ø–Ω–∞');
        console.log('–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –±—Ä–∞—É–∑–µ—Ä–∞:', Notification.permission);
        alert('–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –≤—ã–≤–µ–¥–µ–Ω–∞ –≤ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12)');
    }

    function updateStatus(text, isConnected) {
        const statusEl = document.getElementById('status');
        statusEl.innerText = `–°—Ç–∞—Ç—É—Å: ${text}`;
        statusEl.className = isConnected ? 'connected' : 'disconnected';
        document.getElementById('message-content').disabled = !isConnected;
        document.getElementById('send-button').disabled = !isConnected;
    }

    function updateRoomInfo(text) {
        document.getElementById('room-info').innerText = text;
    }

    function clearMessages() {
        document.getElementById('messages').innerHTML = '';
    }

    // –ó–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', function () {
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }
    });

</script>
</body>
</html>